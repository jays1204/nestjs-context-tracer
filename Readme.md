# nestjs-context-tracer
Trace each http context of your nest.js application.
This enable to trace http request by unique id. Each request has unique Id and You can get id on controller, service, dao, anywhere.


# Usage
## Configuration

`Add module and set middleware` 
- configure middleware for every http method and path

### example 
- app.module.ts
```ts
import { AsyncTraceIdMiddleware, AsyncTraceModule } from 'nestjs-context-tracer';

@Module({
  imports: [ AsyncTraceModule ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule implements NestModule {
    configure(consumer: MiddlewareConsumer) {
    consumer
      .apply(AsyncTraceIdMiddleware)
      .forRoutes({ path: '*', method: RequestMethod.ALL });
  }
}
```

## Get Trace Id
`Use getTraceId method of AsyncContext `

### example
- app.controller.ts

```ts
import { AsyncContext } from 'nestjs-context-tracer';

@Controller()
export class AppController {
  constructor(
    private readonly asyncContext: AsyncContext
  ) {}

  @Get()
  getHello(): string {
    const rand = Math.random();
    console.log('begin trace-id:', this.asyncContext.getTraceId());
    ....
  }
```
You can see unique begin trace-id output by each http request.
trace-id is generated by uuid v4.


## Set & Get For Custom data
You can set any data and get by this library.

### set(key: string, value: unknown)
`asyncContext.set(key, value);`


```ts
key: string
value: unknown

exmpale:
asyncContext.set('role', 'ADMIN');
```


### get(key: string)
asyncContext.get(key);

```ts
key: string

exmpale:
const userRoel = asyncContext.get('role');
```


## Important Note
- This library based on AsyncLocalStorage[https://nodejs.org/docs/latest-v14.x/api/async_hooks.html#async_hooks_class_asynclocalstorage]
AsyncLocalStorage tend to drop application performance.
Drop rate is different by node.js version. It recommend to use v16.2 or above version.
If you more information see below issue. 
https://github.com/nodejs/node/issues/34493#issuecomment-845094849

- Context loss
If your code use callback not promsie, you must read below document. 
https://nodejs.org/dist/latest-v16.x/docs/api/async_context.html#troubleshooting-context-loss

This library inspired by https://github.com/nestjs/nest/pull/1407
